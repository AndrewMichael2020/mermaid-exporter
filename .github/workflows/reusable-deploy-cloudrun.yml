name: Reusable Build and Deploy to Cloud Run

on:
  workflow_call:
    inputs:
      project:
        required: true
        type: string
      service:
        required: true
        type: string
      region:
        required: false
        default: ''
        type: string
      default-region:
        required: false
        default: 'us-central1'
        type: string
      image-tag:
        required: false
        default: '${{ github.sha }}'
        type: string
      secrets-to-check:
        required: false
        default: |
          NEXT_PUBLIC_FIREBASE_API_KEY
          NEXT_PUBLIC_FIREBASE_PROJECT_ID
          NEXT_PUBLIC_FIREBASE_APP_ID
          NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN
          NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET
          NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID
          GEMINI_API_KEY
        type: string
    secrets:
      GCP_SA_KEY:
        required: true

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker auth for GCR
        run: gcloud auth configure-docker --quiet

      - name: Configure gcloud defaults
        env:
          PROJECT: ${{ inputs.project }}
          REGION: ${{ inputs.region }}
        run: |
          set -euo pipefail
          gcloud config set project "$PROJECT"
          # Use provided REGION or fall back to the workflow input 'default-region'
          if [ -n "${REGION:-}" ]; then
            gcloud config set run/region "$REGION"
          else
            gcloud config set run/region "${{ inputs['default-region'] }}"
          fi

      - name: Verify required secrets exist in Secret Manager
        env:
          PROJECT: ${{ inputs.project }}
        run: |
          set -euo pipefail
          IFS=$'\n' read -r -d '' -a secrets <<< "${{ inputs.secrets-to-check }}" || true
          missing_secrets=()
          for s in "${secrets[@]}"; do
            s=$(echo "$s" | xargs)
            if [ -z "$s" ]; then
              continue
            fi
            echo "Checking $s..."
            if ! gcloud secrets describe "$s" --project "$PROJECT" >/dev/null 2>&1; then
              missing_secrets+=("$s")
            fi
          done
          if [ ${#missing_secrets[@]} -gt 0 ]; then
            echo "::error::Missing secrets in Secret Manager: ${missing_secrets[*]}"
            echo "Please create them using: gcloud secrets create <SECRET_NAME> --project=$PROJECT"
            exit 1
          fi
          echo "All required secrets verified."

      - name: Build and push image (Cloud Build)
        env:
          PROJECT: ${{ inputs.project }}
          SERVICE: ${{ inputs.service }}
        run: |
          set -euo pipefail
          TAG="${{ inputs['image-tag'] }}"
          IMAGE="gcr.io/${PROJECT}/${SERVICE}:${TAG::7}"
          IMAGE_LATEST="gcr.io/${PROJECT}/${SERVICE}:latest"
          echo "Building $IMAGE"
          gcloud builds submit \
            --tag "$IMAGE" \
            --tag "$IMAGE_LATEST" \
            --timeout=1200s

      - name: Deploy to Cloud Run
        env:
          PROJECT: ${{ inputs.project }}
          SERVICE: ${{ inputs.service }}
          REGION: ${{ inputs.region }}
        run: |
          set -euo pipefail
          # Determine deploy region: use environment REGION if set, otherwise the workflow input 'default-region'
          if [ -n "${REGION:-}" ]; then
            DEPLOY_REGION="$REGION"
          else
            DEPLOY_REGION="${{ inputs['default-region'] }}"
          fi
          TAG="${{ inputs['image-tag'] }}"
          IMAGE="gcr.io/${PROJECT}/${SERVICE}:${TAG::7}"
          echo "Deploying $SERVICE to Cloud Run ($DEPLOY_REGION)"
          # Map the same secrets from Secret Manager into the service
          update_secrets_args=()
          IFS=$'\n' read -r -d '' -a secrets <<< "${{ inputs['secrets-to-check'] }}" || true
          for s in "${secrets[@]}"; do
            s=$(echo "$s" | xargs)
            if [ -z "$s" ]; then
              continue
            fi
            update_secrets_args+=("--update-secrets" "$s=$s:latest")
          done
          gcloud run deploy "$SERVICE" \
            --image "$IMAGE" \
            --region "$DEPLOY_REGION" \
            --platform managed \
            --allow-unauthenticated \
            --port 8080 \
            --memory 512Mi \
            --cpu 1 \
            --min-instances 0 \
            --max-instances 10 \
            "${update_secrets_args[@]}"

      - name: Get Cloud Run Service URL
        id: service_url
        env:
          PROJECT: ${{ inputs.project }}
          SERVICE: ${{ inputs.service }}
          REGION: ${{ inputs.region }}
        run: |
          set -euo pipefail
          DEPLOY_REGION="${{ inputs.region:-${{ inputs.default-region }}}}"
          url=$(gcloud run services describe "$SERVICE" \
            --platform managed \
            --region "$DEPLOY_REGION" \
            --format='value(status.url)')
          echo "Cloud Run Service URL: $url"
          echo "service_url=$url" >> "$GITHUB_OUTPUT"

      - name: Health check
        env:
          SERVICE_URL: ${{ steps.service_url.outputs.service_url }}
        run: |
          set -euo pipefail
          echo "Performing health check on $SERVICE_URL..."
          max_attempts=5
          attempt=1
          while [ $attempt -le $max_attempts ]; do
            echo "Attempt $attempt of $max_attempts..."
            status_code=$(curl -s -o /dev/null -w "%{http_code}" "$SERVICE_URL" --max-time 30 || echo "000")
            if [ "$status_code" = "200" ]; then
              echo "âœ… Health check passed! Service is healthy."
              exit 0
            fi
            echo "Received status code: $status_code"
            if [ $attempt -lt $max_attempts ]; then
              echo "Waiting 10 seconds before next attempt..."
              sleep 10
            fi
            attempt=$((attempt + 1))
          done
          echo "::warning::Health check did not return 200 after $max_attempts attempts (last status: $status_code)"
          echo "Service may still be starting up. Please verify manually at: $SERVICE_URL"
